<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, height=812, initial-scale=1.0, shrink-to-fit=no, user-scalable=no, viewport-fit=cover">
    <title>Upload</title>
    <link
      type="text/css"
      href="https://uicdn.toast.com/tui-color-picker/v2.2.6/tui-color-picker.css"
      rel="stylesheet"
    />
    <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
    crossorigin="anonymous"
    />
    <link type="text/css" href="css/service-mobile.css" rel="stylesheet" />
    <link rel="stylesheet" href="./edit.css" />
    <link rel="stylesheet" href="../css/index.css" />
  </head>
  <body>
    <!-- Image editor controls - top area -->
    <header class="container-fluid bg-success p-0">
      <div class="safe-area bg-success"></div>
      <h1>Upload</h1>
      <!-- <div class="button" id="take-photo">
        <label for="input-image-file">
          <img src="img/openImage.png"/>
        </label>
        <input type="file" accept="image/*;capture=camera" id="input-image-file" />
      </div> -->
    </header>
    <div class="header">
      <div class="menu">
        <span class="button">Photo
          <input type="file" accept="image/*;capture=camera" id="input-image-file" />
        </span>
        <!-- <span>hi
          <input type="file" accept="image/*;capture=camera" id="input-image-file" />
        </span> -->
        <span class="button" onclick="location.href='../upload.html'">Skip</span>
        <!-- <button class="button" id="btn-remove-active-object"><img src="img/remove.png" /></button> -->
        <span class="button" id="btn-download-new">Done</span>
      </div>
    </div>
    <!-- Image editor area -->
    <div class="tui-image-editor">

      <div class="video-loader">
        <video autoplay="autoplay" loop="loop" muted defaultMuted playsinline  oncontextmenu="return false;"  preload="auto"  id="myVideo">
          <source src="video.mp4" type="video/mp4">
        </video>
      </div>

    </div>

    <!-- Image editor controls - bottom area -->
    <div class="tui-image-editor-controls">
      <ul class="scrollable">
        <li class="menu-item">
          <button class="menu-button" id="btn-crop">Crop</button>
          <div class="submenu">
            <button class="btn-prev">&lt;</button>
            <ul class="scrollable">
              <li class="menu-item">
                <button class="submenu-button" id="btn-apply-crop">Apply</button>
              </li>
            </ul>
          </div>
        </li>
        <li class="menu-item">
          <button class="menu-button">Rotate</button>
          <div class="submenu">
            <button class="btn-prev">&lt;</button>
            <ul class="scrollable">
              <li class="menu-item">
                <button class="submenu-button" id="btn-rotate-clockwise">Rotate +90</button>
              </li>
              <li class="menu-item">
                <button class="submenu-button" id="btn-rotate-counter-clockwise">Rotate -90</button>
              </li>
              <li class="menu-item">
                <button class="submenu-button" id="btn-flip-x">FilpX</button>
              </li>
              <li class="menu-item">
                <button class="submenu-button" id="btn-flip-y">FilpY</button>
              </li>
            </ul>
          </div>
        </li>
        <li class="menu-item">
          <button class="menu-button" id="btn-draw-line">Drawing</button>
          <div class="submenu">
            <button class="btn-prev">&lt;</button>
            <ul class="scrollable">
              <li class="menu-item">
                <button class="submenu-button" id="btn-free-drawing">Free<br />Drawing</button>
              </li>
              <li class="menu-item">
                <button class="submenu-button" id="btn-line-drawing">Line<br />Drawing</button>
              </li>
              <li class="menu-item">
                <button class="submenu-button" id="btn-change-size">Brush<br />Size</button>
                <div class="hiddenmenu">
                  <input id="input-brush-range" type="range" min="10" max="100" value="50" />
                </div>
              </li>
              <li class="menu-item">
                <button class="submenu-button" id="btn-change-text-color">Brush<br />Color</button>
                <div class="hiddenmenu">
                  <div id="tui-brush-color-picker"></div>
                </div>
              </li>
            </ul>
          </div>
        </li>
        <li class="menu-item">
          <button class="menu-button" id="btn-draw-shape">Shape</button>
          <div class="submenu">
            <button class="btn-prev">&lt;</button>
            <ul class="scrollable">
              <li class="menu-item">
                <button class="submenu-button" id="btn-add-rect">Rectagle</button>
              </li>
              <li class="menu-item">
                <button class="submenu-button" id="btn-add-square">Square</button>
              </li>
              <li class="menu-item">
                <button class="submenu-button" id="btn-add-ellipse">Ellipse</button>
              </li>
              <li class="menu-item">
                <button class="submenu-button" id="btn-add-circle">Circle</button>
              </li>
              <li class="menu-item">
                <button class="submenu-button" id="btn-add-triangle">Triangle</button>
              </li>
              <li class="menu-item">
                <button class="submenu-button" id="btn-stroke-size">Stroke<br />Size</button>
                <div class="hiddenmenu">
                  <input id="input-stroke-range" type="range" min="1" max="100" value="10" />
                </div>
              </li>
              <li class="menu-item">
                <button class="submenu-button" id="btn-change-shape-color">Color</button>
                <div class="hiddenmenu">
                  <div class="top">
                    <label for="fill-color"
                      ><input
                        type="radio"
                        id="fill-color"
                        name="select-color-type"
                        value="fill"
                        checked="checked"
                      />
                      Fill</label
                    >
                    <label for="stroke-color"
                      ><input
                        type="radio"
                        id="stroke-color"
                        name="select-color-type"
                        value="stroke"
                      />
                      Stroke</label
                    >
                    <label for="input-check-transparent"
                      ><input type="checkbox" id="input-check-transparent" />Transparent</label
                    >
                  </div>
                  <div id="tui-shape-color-picker"></div>
                </div>
              </li>
            </ul>
          </div>
        </li>
        <li class="menu-item">
          <button class="menu-button">Icon</button>
          <div class="submenu">
            <button class="btn-prev">&lt;</button>
            <ul class="scrollable">
              <li class="menu-item">
                <button class="submenu-button" id="btn-add-arrow-icon">Arrow<br />Icon</button>
              </li>
              <li class="menu-item">
                <button class="submenu-button" id="btn-add-cancel-icon">Cancel<br />Icon</button>
              </li>
              <li class="menu-item">
                <button class="submenu-button" id="btn-change-icon-color">Color</button>
                <div class="hiddenmenu">
                  <div id="tui-icon-color-picker"></div>
                </div>
              </li>
            </ul>
          </div>
        </li>
        <li class="menu-item">
          <button class="menu-button" id="btn-add-text">Text</button>
          <div class="submenu">
            <button class="btn-prev">&lt;</button>
            <ul class="scrollable">
              <li class="menu-item">
                <button class="submenu-button" id="btn-change-size">Size</button>
                <div class="hiddenmenu">
                  <input id="input-text-size-range" type="range" min="10" max="240" value="120" />
                </div>
              </li>
              <li class="menu-item">
                <button class="submenu-button" id="btn-change-style">Style</button>
                <div class="hiddenmenu">
                  <button class="hiddenmenu-button btn-change-text-style" data-style-type="bold">
                    <b>Bold</b>
                  </button>
                  <button class="hiddenmenu-button btn-change-text-style" data-style-type="italic">
                    <i>Italic</i>
                  </button>
                  <button
                    class="hiddenmenu-button btn-change-text-style"
                    data-style-type="underline"
                  >
                    <u>Underline</u>
                  </button>
                </div>
              </li>
              <li class="menu-item">
                <button class="submenu-button" id="btn-change-align">Align</button>
                <div class="hiddenmenu">
                  <button class="hiddenmenu-button btn-change-text-style" data-style-type="left">
                    Left
                  </button>
                  <button class="hiddenmenu-button btn-change-text-style" data-style-type="center">
                    Center
                  </button>
                  <button class="hiddenmenu-button btn-change-text-style" data-style-type="right">
                    Right
                  </button>
                </div>
              </li>
              <li class="menu-item">
                <button class="submenu-button" id="btn-change-text-color">Color</button>
                <div class="hiddenmenu">
                  <div id="tui-text-color-picker"></div>
                </div>
              </li>
            </ul>
          </div>
        </li>
      </ul>
      <p class="msg">Menu Scrolling <b>Left ⇔ Right</b></p>

    </div>
    <footer class="container-fluid bg-success p-0">
      <div class="d-flex justify-content-around w-100">
          <a href="/food-list.html" class="text-light"
              ><i class="fa fa-cutlery" aria-hidden="true"></i
          ></a>
          <a href="./edit.html" class="text-light"
              ><i class="fa fa-upload" aria-hidden="true"></i
          ></a>
          <a href="/home-page.html" class="text-light"
              ><i class="fa fa-home" aria-hidden="true"></i
          ></a>
          <a href="/history.html" class="text-light"
              ><i class="fa fa-history" aria-hidden="true"></i
          ></a>
          <a href="/profile.html" class="text-light"
              ><i class="fa fa-user" aria-hidden="true"></i
          ></a>
      </div>
      <div class="safe-area bg-success"></div>
  </footer>
    <script type="text/javascript" src="js/theme/white-theme.js"></script>
    <script
      type="text/javascript"
      src="https://api-storage.cloud.toast.com/v1/AUTH_e18353c4ea5746c097143946d0644e61/toast-ui-cdn/tui-image-editor/v3.11.0/example/fabric-v4.2.0.js"
    ></script>
    <script
      type="text/javascript"
      src="https://uicdn.toast.com/tui.code-snippet/v1.5.0/tui-code-snippet.min.js"
    ></script>
    <script
      type="text/javascript"
      src="https://uicdn.toast.com/tui-color-picker/v2.2.6/tui-color-picker.min.js"
    ></script>
    <script
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.8.3/jquery.min.js"
    ></script>
    <script
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.3/FileSaver.min.js"
    ></script>
    <script type="text/javascript" src="./dist/tui-image-editor.js"></script>
    <script type="module" src="js/service-mobile.js"></script>
    <!-- <script type="module" src="js/edit.js"></script> -->
    <!-- <script type="module" src="./js/test.js"></script> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js"></script>
    <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>
    <script src="https://cdn.jsdelivr.net/gh/wallat/compiled-opencvjs/v4.2.0/opencv.js" type="text/javascript"></script>
    <script>

      function timer(t){
        return new Promise((rec,rej) =>{
          setTimeout(() => { rec() }, t);
        })

      }

      document.getElementById('btn-download-new').addEventListener('click', async (e) => {
        const header = document.querySelector('.header')
        const loader = document.querySelector('.video-loader')
        const footer = document.querySelector('.tui-image-editor-controls')

        loader.style.display = 'flex'
        header.innerHTML = /* html */ `<h2>loading</h2>`
        footer.innerHTML = /* html */ `<h2>this may take a while...</h2>`

        img = document.querySelector('.lower-canvas')
        let canvas = document.createElement('canvas')
        canvas.classList.add("my-canvas")
        let ctx = canvas.getContext('2d');
        canvas.width=img.width / 4
        canvas.height=img.height / 4
        console.log(canvas.width, canvas.height)
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height)
        document.body.appendChild(canvas)

        await timer(2000);

        Tesseract.recognize(
          document.querySelector('.my-canvas'),
          'eng+chi_tra',
          { logger: m => console.log(m) }
        ).then(({ data: { text } }) => {
          let result = {}
          const lines = text.split('\n')

          function insertData(line, nutrition){
            const text = spellChecker(line.match(/\d+(.*)/)[0])

            if(line.includes("/")){
              result[nutrition] = text.match(/\d*\.?\d*(?=.{1}[\/])/g)[0]

            } else {
              result[nutrition] = text.match(/[+-]?\d+(\.\d+)?/g)[0]
            }

          }

          function insertDataTwoUnit(line, nutrition){
            const text = spellChecker(line.match(/\d+(.*)/)[0])

            if(line.includes("/")){
              result[nutrition] = text.match(/\d*\.?\d*(?=.{2}[\/])/g)[0]

            } else {
              result[nutrition] = text.match(/[+-]?\d+(\.\d+)?/g)[0]
            }
          }

          function insertDataFourUnit(line, nutrition){
            const text = spellChecker(line.match(/\d+(.*)/)[0])

            if(line.includes("/")){
              result[nutrition] = text.match(/\d*\.?\d*(?=.{4}[\/])/g)[0]

            } else {
              result[nutrition] = text.match(/[+-]?\d+(\.\d+)?/g)[0]
            }
          }

          function spellChecker(text){
            if(text.includes("i")){
              text = text.replace('i', '1')
            }
            if(text.includes("O")){
              text = text.replace("O", "0")
            }
            if(text.includes(";")){
              text = text.replace(";", ".")
            }
            if(text.includes(",")){
              text = text.replace(",", ".")
            }
            if(text.includes("G")){
              text = text.replace("G", "6")
            }
            if(text.includes("﹒")){
              text = text.replace("﹒", ".")
            }
            if(text.includes("T")){
              text = text.replace("T", "7")
            }
            return text
          }

          for (let line of lines) {

            if(line.toLowerCase().includes("per") && line.toLowerCase().includes("100")){
              result['per'] = 'per_100'
            } else if (line.toLowerCase().includes("per") && line.toLowerCase().includes("ser")){
              result['per'] = 'per_serving'
            } else if (line.toLowerCase().includes("per") && line.toLowerCase().includes("pac")){
              result['per'] = 'per_package'
            }

            if(line.toLowerCase().includes("ser") && line.toLowerCase().includes("size")){
              insertData(line, 'serving_size')
            }

            if(line.toLowerCase().includes("ener")){
              insertDataFourUnit(line, 'energy')
            }

            if(line.toLowerCase().includes("pro") || line.toLowerCase().includes("ein")){
              insertData(line, 'protein')
            }

            if(line.toLowerCase().includes("tot") && line.toLowerCase().includes("fat")){
              insertData(line, 'total_fat')
            }

            if(line.toLowerCase().includes("urated") && line.toLowerCase().includes("fat")){
              insertData(line, 'saturated_fat')
            }

            if(line.toLowerCase().includes("tran") && line.toLowerCase().includes("fat")){
              insertData(line, 'trans_fat')
            }

            if(line.toLowerCase().includes("carbo")){
              insertData(line, 'carbohydrates')
            }

            if(line.toLowerCase().includes("sug")){
              insertData(line, 'sugar')
            }

            if(line.toLowerCase().includes("sod")){
              insertDataTwoUnit(line, 'sodium')
            }
          }
          localStorage.setItem('data', JSON.stringify({"data": result}))
          console.log(text)
          // window.location = '../../upload.html'

        })
      })
    </script>
  </body>
</html>